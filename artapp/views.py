from django.core.paginator import Paginator
from django.http import HttpResponse, JsonResponse
from django.shortcuts import render, redirect
from artapp.models import  ArtTag,Art
# Create your views here.


def index(request):
    # 获取请求参数中的tag标签分类的id
    tag_id = request.GET.get('tag')
    page_num = request.GET.get('page')

    if not page_num:
        page_num = 1
    # 如果tag_id不存在时,则表示为所有(即不分类型)
    if not tag_id:
        tag_id = 0
        arts = Art.objects.all()
    # 根据分类查找
    else:
        arts = Art.objects.filter(tag_id=tag_id).all()

    # 分页器,每页显示4条数据
    paginator = Paginator(arts,1)
    #  获取第 page_num 页
    page = paginator.page(page_num)
    print(paginator.page_range)
    # 返回渲染模板
    return render(request,'art/list.html',context = {'arts':page.object_list ,
                                                     'page_range':paginator.page_range,
                                                     'page':page,
                                                     'tag_id':tag_id,
                                                     'tags':ArtTag.objects.all()})



def add_tags(request):
    # 第一次跳转,编辑
    if request.method == 'GET':
        # 新增编辑(不带tag的id),修改编辑(带tag的id) ,
        # 判断是否为修改
        id = request.GET.get('id')
        # print(id)  # 1
        # print(type(id))  # str
        tag = None
        if id :
            # 存在id,即为修改
            tag = ArtTag.objects.get(id=id)
        return render(request,'art/edit_tags.html',{'tag':tag})

    # 第二次跳转,为表单的post提交,新增修改
    else:
        # post 请求
        # 新增 和 修改
        if request.POST.get('id'):
            tag = ArtTag.objects.get(id = request.POST.get('id'))
        else:
            tag = ArtTag()
        tag.title = request.POST.get('title')
        tag.save()  # 保存到数据库
        return redirect('/art/list_tags')  # 重定向


def delete_tag(request):
    id = request.GET.get('id')
    if id:
        result = ArtTag.objects.filter(id=id)
        # print(result)  # <QuerySet [<ArtTag: ArtTag object>]>
        # print(type(result))  # <class 'django.db.models.query.QuerySet'>
        # 判断查询集是否存在
        if result.exists():
            result.delete()
    # 重定向到列表页面
    return redirect('/art/list_tags')


def list_tags(request):
    return render(request,'art/tags_list.html',
                  context={'tags':ArtTag.objects.all()})


